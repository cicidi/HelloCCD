
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>

<!-- LOCALIZATION RELATED INFORMATION -->
<meta name="LOC_PROJ_ID" content="WLPF8.1" />
<meta name="LOC_OWNER" content="BEAJ" />
<meta name="LOC_STATUS" content="READY!" />
<meta name="LOC_COMMENT" content="LOC_COMMENT" />
<meta name="LOC_US_REV" content="11" />
<meta name="LOC_US_CHANGE" content="1120948" />
<meta name="LOC_US_SRCFILE" content="//depot/docs/dante/fm/cluster/load_balancing.fm" />
<!-- LOCALIZATION RELATED INFORMATION -->

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta name="GENERATOR" content="Quadralay WebWorks AutoMap 2003 Platinum Edition for FrameMaker 8.5.4178.1" />
    <meta name="TEMPLATEBASE" content="BEA_WFP_Template_V1.04" />
    <meta name="LASTUPDATED" content="05/22/08 08:22:33" />
    <link rel="StyleSheet" href="../../global_resources/edocs.css" type="text/css" media="all" />

<title>Load Balancing in a Cluster</title>

<!-- BEA scripts begin -->

<script language="Javascript" src="../../global_resources/js/banner.js" type="text/javascript"></script>
<!-- This script outputs the banner required for edocs documentation. -->

<script language="Javascript" src="../../global_resources/js/breadcrumb.js" type="text/javascript"></script>
<!-- This script outputs the product breadcrumb required for edocs documentation. -->

<script language="Javascript" src="floatwin.js" type="text/javascript"></script>
<!-- This script opens a new small floating window and puts TOC<i>&lt;name&gt;</i>.html and IX<i>&lt;name&gt;</i>.html files in it and sets a generic popup window code to enable the display of some viewlets in the WebLogic Platform Tour. -->

<script language="Javascript1.1" src="../../global_resources/js/footer.js" type="text/javascript"></script>
<!-- This script outputs the footer with the correct copyright date and link to copyright page.-->

<script language="Javascript1.1" src="../../global_resources/js/googlesearch4.js" type="text/javascript"></script>
<!-- This script outputs the google search form. -->

<script language="Javascript1.1" src="../../global_resources/js/note.js" type="text/javascript"></script>
<!-- This script outputs a note such as a BETA note. -->

<script language="JavaScript1.1" src="../../global_resources/js/search.js" type="text/javascript"></script>
<!-- This script is not for online documents. It is only used by the QuestAgent Java Applet for CD search indexes. -->

<!-- BEA scripts end -->

  </head>

  <body>


<script language="Javascript1.1" type="text/javascript">
GoogleURL();
</script><noscript>This script outputs the google search URL required for search on edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
Banner();
</script><noscript>This script outputs the banner required for edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
GoogleSearchCollection();
</script><noscript>This script outputs the google search parameters required for search on edocs documentation.</noscript>


<!-- Breadcrumbs begin -->
<div class="breadcrumb">
<script language="Javascript1.1" type="text/javascript">
Breadcrumb();
</script><noscript>This script outputs the product breadcrumb required for edocs documentation.</noscript> 

&gt; <span style="text-transform:capitalize;"><a href="index.html">Using WebLogic Server 
Clusters
</a></span> &gt; Load Balancing in a Cluster



</div>

<!-- Breadcrumbs end -->

<!-- page title -->
<h1 class="booktitle">Using WebLogic Server 
Clusters
</h1>
<!-- page title end -->

    <table id="SummaryNotReq1" width="100%" border="0" align="left" cellpadding="2%" cellspacing="0">
      <tr> 
        <td>
&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="config.html"><img id="LongDescNotReq1" src="../../global_resources/images/doc_nav_prev.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="failover.html"><img id="LongDescNotReq2" src="../../global_resources/images/doc_nav_next.gif" border="0" alt="Next" /></a>&nbsp;
<img id="LongDescNotReq3" src="../../global_resources/images/doc_nav_dots.gif" border="0" alt="" />&nbsp;
<a accesskey="1" href="javascript:OpenWindowToc();" onmouseover="window.status='Table of Contents'; return true" onfocus="window.status='Table of Contents'; return true" onmouseout="window.status=''; return true" onblur="window.status=''; return true" title="Open TOC in new window">      <img id="LongDescNotReq4" src="../../global_resources/images/doc_nav_contents.gif" alt="Open TOC in new window" border="0" /></a>&nbsp;
&nbsp;
<a href="../pdf/cluster.pdf" target="pdf"><img id="LongDescNotReq5" src="../../global_resources/images/doc_nav_pdf.gif" width="59" height="44" alt="View as PDF - New Window" title="View as PDF - New Window" border="0" /></a>&nbsp;
<a href="http://www.adobe.com/products/acrobat/alternate.html" target="_blank"><img id="LongDescNotReq6" src="../../global_resources/images/get_reader.gif" width="52" height="44" alt="Get Adobe Reader - New Window" title="Get Adobe Reader - New Window" border="0" /></a>
<a name="link_group_0"></a>
	</td>
      </tr>
    </table>

<a name="skipnav" title="Content starts here"><img src="../../global_resources/images/_.gif" alt="Content starts here" border="0" height="1" width="1" /></a>



<h1 class="pChapHead"><a name="wp1044135"> </a>
Load Balancing in a Cluster
</h1>
<p class="pBody"><a name="wp1025234"> </a>
This section describes the load balancing support that a WebLogic Server cluster provides for different types of objects, and related planning and configuration considerations for architects and administrators. It contains the following information:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1027365"> </a><a href="load_balancing.html#wp1026940">Load Balancing for Servlets and JSPs</a></li>
<li><a name="wp1026937"> </a><a href="load_balancing.html#wp1008605">Load Balancing for EJBs and RMI Objects</a></li>
<li><a name="wp1031556"> </a><a href="load_balancing.html#wp1043771">Load Balancing for JMS</a></li>
<li><a name="wp1031561"> </a><a href="load_balancing.html#wp1031590">Load Balancing for JDBC Connections</a></li>
</ul></div>
<p class="pBody"><a name="wp1038294"> </a>
For information about replication and failover in a cluster, see <a href="failover.html">Failover and Replication in a Cluster</a>.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1026940"> </a>
Load Balancing for Servlets and JSPs
</h2><p class="pBody"><a name="wp1021313"> </a>
Load balancing of servlets and JSPs can be accomplished with the built-in load balancing capabilities of a WebLogic proxy plug-in or with separate load balancing hardware. 
</p>
<a name="wp1033055"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>In addition to distributing HTTP traffic, external load balancers can distribute initial context requests that come from Java clients over t3 and the default channel. See <a href="load_balancing.html#wp1008605"></a><a href="load_balancing.html#wp1008605">Load Balancing for EJBs and RMI Objects</a> for a discussion of object-level load balancing in WebLogic Server. </td>
</tr>
</table>

<h3 class="pHeading2"><a name="wp1025517"> </a>
Load Balancing with a Proxy Plug-in
</h3>
<p class="pBody"><a name="wp1026202"> </a>
The WebLogic proxy plug-in maintains a list of WebLogic Server instances that host a clustered servlet or JSP, and forwards HTTP requests to those instances on a round-robin basis. This load balancing method is described in <a href="load_balancing.html#wp1045316"><span class="cHyperlink">
Round Robin Load Balancing</span></a>.
</p>
<p class="pBody"><a name="wp1025521"> </a>
The plug-in also provides the logic necessary to locate the replica of a client&#8217;s HTTP session state if a WebLogic Server instance should fail.
</p>
<p class="pBody"><a name="wp1025525"> </a>
WebLogic Server supports the following Web servers and associated proxy plug-ins: 
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1025499"> </a>WebLogic Server with the <code class="cCode">HttpClusterServlet</code></li>
<li><a name="wp1025501"> </a>Netscape Enterprise Server with the Netscape (proxy) plug-in </li>
<li><a name="wp1025503"> </a>Apache with the Apache Server (proxy) plug-in</li>
<li><a name="wp1025505"> </a>Microsoft Internet Information Server with the Microsoft-IIS (proxy) plug-in</li>
</ul></div>
<p class="pBody"><a name="wp1028390"> </a>
For instructions on setting up proxy plug-ins, see <a href="setup.html#wp684345">Configure Proxy Plug-Ins</a>.
</p>
<h4 class="pHeading3"><a name="wp1029887"> </a>
How Session Connection and Failover Work with a Proxy Plug-in
</h4>
<p class="pBody"><a name="wp1045182"> </a>
For a description of connection and failover for HTTP sessions in a cluster with proxy plug-ins, see <a href="failover.html#wp1022255">Accessing Clustered Servlets and JSPs Using a Proxy</a>.
</p>
<h3 class="pHeading2"><a name="wp1045188"> </a>
Load Balancing HTTP Sessions with an Ext<a name="ExternalLoadBalancer"></a>ernal Load Balancer
</h3>
<p class="pBody"><a name="wp1045189"> </a>
Clusters that utilize a hardware load balancing solution can use any load balancing algorithm supported by the hardware. These can include advanced load-based balancing strategies that monitor the utilization of individual machines.
</p>
<h4 class="pHeading3"><a name="wp1033222"> </a>
Load Balancer Configuration Requirements
</h4>
<p class="pBody"><a name="wp1025700"> </a>
If you choose to use load balancing hardware instead of a proxy plug-in, it must support a compatible passive or active cookie persistence mechanism, and SSL persistence. 
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1025701"> </a>Passive Cookie Persistence</li>
<p class="pBodyRelative"><a name="wp1025705"> </a>
Passive cookie persistence enables WebLogic Server to write a cookie containing session parameter information through the load balancer to the client. For information about the session cookie and how a load balancer uses session parameter data to maintain the relationship between the client and the primary WebLogic Server hosting a HTTP session state, see <a href="load_balancing.html#wp1028843">Load Balancers and the WebLogic Session Cookie</a>. 
</p>
<li><a name="wp1025709"> </a>Active Cookie Persistence </li>
<p class="pBodyRelative"><a name="wp1028664"> </a>
Certain active cookie persistence mechanisms can be used with WebLogic Server clusters, provided the load balancer <em class="cEmphasis">does not</em> modify the WebLogic Server cookie. WebLogic Server clusters do not support active cookie persistence mechanisms that overwrite or modify the WebLogic HTTP session cookie. If the load balancer&#8217;s active cookie persistence mechanism works by adding its own cookie to the client session, no additional configuration is required to use the load balancer with a WebLogic Server cluster.
</p>
<li><a name="wp1025711"> </a>SSL Persistence</li>
<p class="pBodyRelative"><a name="wp1028842"> </a>
When SSL persistence is used, the load balancer performs all encryption and decryption of data between clients and the WebLogic Server cluster. The load balancer then uses the plain text cookie that WebLogic Server inserts on the client to maintain an association between the client and a particular server in the cluster.
</p>
</ul></div>
<h4 class="pHeading3"><a name="wp1028843"> </a>
Load Balancers and the WebLogic Session Cookie
</h4>
<p class="pBody"><a name="wp1044571"> </a>
A load balancer that uses passive cookie persistence can use a string in the WebLogic session cookie to associate a client with the server hosting its primary HTTP session state. The string uniquely identifies a server instance in the cluster. You must configure the load balancer with the offset and length of the string constant. The correct values for the offset and length depend on the format of the session cookie.
</p>
<p class="pBody"><a name="wp1044573"> </a>
The format of a session cookie is:
</p>
<p class="pBody"><a name="wp1044456"> </a>
<code class="cCode">sessionid</code>!<code class="cCode">primary_server_id</code>!<code class="cCode">secondary_server_id</code>
</p>
<p class="pBody"><a name="wp1044483"> </a>
where:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1028735"> </a><code class="cCode">sessionid</code> is a randomly generated identifier of the HTTP session. The length of the value is configured by the <code class="cCode">IDLength</code> parameter in the <span class="cHyperlink">
&lt;</span>session<a href="../webapp/weblogic_xml.html"></a>-descriptor&gt; element in the <code class="cCode">weblogic.xml</code> file for an application. By default, the <code class="cCode">sessionid</code> length is 52 bytes.</li>
<li><a name="wp1028740"> </a><code class="cCode">primary_server_id</code> and <code class="cCode">secondary_server_id</code> are 10 character identifiers of the primary and secondary hosts for the session. </li>
</ul></div>
<a name="wp1044608"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>For sessions using non-replicated memory, cookie, JDBC, or file-based session persistence, the <code class="cCode">secondary_server_id</code> is not present. For sessions that use in-memory replication, if the secondary session does not exist, the <code class="cCode">secondary_server_id</code>   is &#8220;NONE&#8221;. </td>
</tr>
</table>

<p class="pBody"><a name="wp1044705"> </a>
For general instructions on configuring load balancers, see <a href="setup.html#wp688662">Configuring Load Balancers that Support Passive Cookie Persistence</a>. Instructions for configuring BIG-IP, see <a href="bigip.html">Configuring BIG-IP&#8482; Hardware with Clusters</a>.
</p>
<h4 class="pHeading3"><a name="wp1029742"> </a>
Related Programming Considerations 
</h4>
<p class="pBody"><a name="wp1029743"> </a>
For programming constraints and recommendations for clustered servlets and JSPs, see <a href="failover.html#wp1033132">Programming Considerations for Clustered Servlets and JSPs</a>.
</p>
<h4 class="pHeading3"><a name="wp1029840"> </a>
How Session Connection and Failover Works with a Load Balancer
</h4>
<p class="pBody"><a name="wp1029832"> </a>
For a description of connection and failover for HTTP sessions in a cluster with load balancing hardware, see <a href="failover.html#wp1022381">Accessing Clustered Servlets and JSPs with Load Balancing Hardware</a>.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1008605"> </a>
Load <a name="LoadBalancingforEJBsandRMIObjects"></a>Balancing for EJBs and RMI Objects
</h2><p class="pBody"><a name="wp1045231"> </a>
This section describes WebLogic Server load balancing algorithms for EJBs and RMI objects.
</p>
<p class="pBody"><a name="wp1045232"> </a>
The load balancing algorithm for an object is maintained in the replica-aware stub obtained for a clustered object. 
</p>
<p class="pBody"><a name="wp1045238"> </a>
By default, a WebLogic Server cluster uses round-robin load balancing, described in <a href="load_balancing.html#wp1045316">Round Robin Load Balancing</a>. You can configure a different default load balancing method for the cluster by using the Administration Console to set <code class="cCode">weblogic.cluster.defaultLoadAlgorithm</code>. For instructions, see <a href="setup.html#wp684313">Configure Load Balancing Method for EJBs and RMIs</a>. You can also specify the load balancing algorithm for a specific RMI object using the <code class="cCode">-loadAlgorithm</code> option in <code class="cCode">rmic</code>, or with the <code class="cCode">home-load-algorithm</code> or <code class="cCode">stateless-bean-load-algorithm</code> in an EJB&#8217;s deployment descriptor. A load balancing algorithm that you configure for an object overrides the default load balancing algorithm for the cluster. 
</p>
<p class="pBody"><a name="wp1045250"> </a>
In addition to the standard load balancing algorithms, WebLogic Server supports custom parameter-based routing. For more information, see <a href="load_balancing.html#wp1036227">Parameter-Based Routing for Clustered Objects</a>.
</p>
<h3 class="pHeading2"><a name="wp1045316"> </a>
<a name="LoadBalancingAlgorithms"></a>Round Robin<a name="round_robin_lb"></a> Load Balancing 
</h3>
<p class="pBody"><a name="wp1045320"> </a>
WebLogic Server uses the round-robin algorithm as the default load balancing strategy for clustered object stubs when no algorithm is specified. This algorithm is supported for RMI objects and EJBs.   It is also the method used by WebLogic proxy plug-ins.
</p>
<p class="pBody"><a name="wp1045324"> </a>
The round-robin algorithm cycles through a list of WebLogic Server instances in order. For clustered objects, the server list consists of WebLogic Server instances that host the clustered object. For proxy plug-ins, the list consists of all WebLogic Server instances that host the clustered servlet or JSP. 
</p>
<p class="pBody"><a name="wp1045331"> </a>
The advantages of the round-robin algorithm are that it is simple, cheap and very predictable. The primary disadvantage is that there is some chance of <em class="cEmphasis">convoying</em>. Convoying occurs when one server is significantly slower than the others. Because replica-aware stubs or proxy plug-ins access the servers in the same order, a slow server can cause requests to &#8220;synchronize&#8221; on the server, then follow other servers in order for future requests.
</p>
<a name="wp1045335"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>WebLogic Server does not always load balance an object&#8217;s method calls. For more information, see <a href="load_balancing.html#wp1026599">Optimization for Collocated Objects</a>.</td>
</tr>
</table>

<h3 class="pHeading2"><a name="wp1045342"> </a>
Weight-Based Load <a name="WeightBasedLoadBalancing"></a>Balan<a name="Weight-based"></a>cing 
</h3>
<p class="pBody"><a name="wp1045343"> </a>
This algorithm applies only to EJB and RMI object clustering. 
</p>
<p class="pBody"><a name="wp1045344"> </a>
Weight-based load balancing improves on the round-robin algorithm by taking into account a pre-assigned weight for each server. You can use the Server -&gt; Configuration -&gt; Cluster tab in the Administration Console to assign each server in the cluster a numerical weight between 1 and 100, in the Cluster Weight field. This value determines what proportion of the load the server will bear relative to other servers. If all servers have the same weight, they will each bear an equal proportion of the load. If one server has weight 50 and all other servers have weight 100, the 50-weight server will bear half as much as any other server. This algorithm makes it possible to apply the advantages of the round-robin algorithm to clusters that are not homogeneous. 
</p>
<p class="pBody"><a name="wp1045345"> </a>
If you use the weight-based algorithm, carefully determine the relative weights to assign to each server instance. Factors to consider include:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1045346"> </a>The processing capacity of the server&#8217;s hardware in relationship to other servers (for example, the number and performance of CPUs dedicated to WebLogic Server).</li>
<li><a name="wp1045350"> </a>The number of non-clustered (&#8220;pinned&#8221;) objects each server hosts.</li>
</ul></div>
<p class="pBody"><a name="wp1045351"> </a>
If you change the specified weight of a server and reboot it, the new weighting information is propagated throughout the cluster via the replica-aware stubs. For related information see <a href="features.html#wp1007508">Cluster-Wide JNDI Naming Service</a>.
</p>
<a name="wp1045358"> </a><table class="Note">
<tr>
<td valign="top"><strong>Notes:</strong></td>
<td>WebLogic Server does not always load balance an object&#8217;s method calls. For more information, see <a href="load_balancing.html#wp1026599">Optimization for Collocated Objects</a>.</td></tr>
</table>

<a name="wp1045362"> </a><table class="Note">
<tr>
<td valign="top"><b class="texthide">Note:</b></td>
<td>In this version of WebLogic Server, weight-based load balancing is not supported for objects that communicate using the RMI/IIOP protocol. </td>
</tr>
</table>
<h3 class="pHeading2"><a name="wp1045365"> </a>
Random L<a name="random_lb"></a>oad Balancing
</h3>
<p class="pBody"><a name="wp1045366"> </a>
The random method of load balancing applies only to EJB and RMI object clustering.
</p>
<p class="pBody"><a name="wp1045367"> </a>
In random load balancing, requests are routed to servers at random. Random load balancing is recommended only for homogeneous cluster deployments, where each server instance runs on a similarly configured machine. A random allocation of requests does not allow for differences in processing power among the machines upon which server instances run. If a machine hosting servers in a cluster has significantly less processing power than other machines in the cluster, random load balancing will give the less powerful machine as many requests as it gives more powerful machines. 
</p>
<p class="pBody"><a name="wp1045368"> </a>
Random load balancing distributes requests evenly across server instances in the cluster, increasingly so as the cumulative number of requests increases. Over a small number of requests the load may not be balanced exactly evenly. 
</p>
<p class="pBody"><a name="wp1045369"> </a>
Disadvantages of random load balancing include the slight processing overhead incurred by generating a random number for each request, and the possibility that the load may not be evenly balanced over a small number of requests. 
</p>
<a name="wp1045373"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>WebLogic Server does not always load balance an object&#8217;s method calls. For more information, see <a href="load_balancing.html#wp1026599">Optimization for Collocated Objects</a>.</td>
</tr>
</table>

<h3 class="pHeading2"><a name="wp1045397"> </a>
Server Affinity Load <a name="server_affinity_lb"></a>Balancing Algorithms
</h3>
<p class="pBody"><a name="wp1045398"> </a>
WebLogic Server provides three load balancing algorithms for RMI objects that provide <span style="font-style: italic">server affinity. </span>Server affinity turns off load balancing for external client connections: instead, the client considers its existing connections to WebLogic server instances when choosing the server instance on which to access an object. If an object is configured for server affinity, the client-side stub attempts to choose a server instance to which it is already connected, and continues to use the same server instance for method calls. All stubs on that client attempt to use that server instance. If the server instance becomes unavailable, the stubs fail over, if possible, to a server instance to which the client is already connected.
</p>
<p class="pBody"><a name="wp1045399"> </a>
The purpose of server affinity is to minimize the number IP sockets opened between external Java clients and server instances in a cluster. WebLogic Server accomplishes this by causing method calls on objects to &#8220;stick&#8221; to an existing connection, instead of being load balanced among the available server instances. With server affinity algorithms, the less costly server-to-server connections are still load-balanced according to the configured load balancing algorithm&#8212;load balancing is disabled only for external client connections. 
</p>
<p class="pBody"><a name="wp1045400"> </a>
Server affinity is used in combination with one of the standard load balancing methods: round-robin, weight-based, or random:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1045401"> </a>round-robin-affinity&#8212;server affinity governs connections between external Java clients and server instances; round robin load balancing is used for connections between server instances.</li>
<li><a name="wp1045402"> </a>weight-based-affinity&#8212;server affinity governs connections between external Java clients and server instances; weight-based load balancing is used for connections between server instances.</li>
<li><a name="wp1045403"> </a>random-affinity&#8212;server affinity governs connections between external Java clients and server instances; random load balancing is used for connections between server instances.</li>
</ul></div>
<h4 class="pHeading3"><a name="wp1043121"> </a>
Server Affinity and Initial Context
</h4>
<p class="pBody"><a name="wp1043164"> </a>
A client can request an initial context from a particular server instance in the cluster, or from the cluster by specifying the cluster address in the URL. The connection process varies, depending on how the context is obtained: 
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1043296"> </a>If the initial context is requested from a specific Managed Server, the context is obtained using a new connection to the specified server instance. </li>
<li><a name="wp1043310"> </a>If the initial context is requested from a the cluster, by default, context requests are load balanced on a round-robin basis among the clustered server instances. To reuse an existing connection between a particular JVM and the cluster, set <code class="cCode">ENABLE_SERVER_AFFINITY</code> to true in the hashtable of <code class="cCode">weblogic.jndi.WLContext</code> properties you specify when obtaining context. (If a connection is not available, a new connection is created.) <code class="cCode">ENABLE_SERVER_AFFINITY</code> is only supported when the context is requested from the cluster address. </li>
</ul></div>
<h4 class="pHeading3"><a name="wp1045426"> </a>
Server Affinity and IIOP<a name="ServerAffinityCSIv2"></a> Client Authentication Using CSIv2
</h4>
<p class="pBody"><a name="wp1045422"> </a>
If you use WebLogic Server&#8217;s Common Secure Interoperability (CSIv2) functionality to support stateful interactions with WebLogic Server&#8217;s Java EE Application Client (&#8220;thin client&#8221;), you must use an affinity-based load balancing algorithm to ensure that method calls stick to a server instance. Otherwise, all remote calls will be authenticated. To prevent redundant authentication of stateful CSIv2 clients, use one of the load balancing algorithms described in <a href="load_balancing.html#wp1035134">Round-Robin Affinity, Weight-Based Affinity, and Random-Affinity</a>.
</p>
<h4 class="pHeading3"><a name="wp1035134"> </a>
Round-Robin Affinity, Weight-Based Affinity, and Random-Affinity
</h4>
<p class="pBody"><a name="wp1035889"> </a>
WebLogic Server has three load balancing algorithms that provide server affinity:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1036707"> </a>round-robin-affinity </li>
<li><a name="wp1036710"> </a>weight-based-affinity</li>
<li><a name="wp1036714"> </a>random-affinity</li>
</ul></div>
<p class="pBody"><a name="wp1036717"> </a>
Server affinity is supported for all types of RMI objects including JMS objects, all EJB home interfaces, and stateless EJB remote interfaces. 
</p>
<p class="pBody"><a name="wp1039764"> </a>
The server affinity algorithms consider existing connections between an external Java client and server instances in balancing the client load among WebLogic server instances. Server affinity: 
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1040241"> </a>turns off load balancing between external Java clients and server instances</li>
<li><a name="wp1040242"> </a>causes method calls from an external Java client to stick to a server instance to which the client has an open connection, assuming that the connection supports the necessary protocol and QOS</li>
<li><a name="wp1035230"> </a>in the case of failure, causes the client to failover to a server instance to which it has an open connection, assuming that the connection supports the necessary protocol and QOS</li>
<li><a name="wp1042637"> </a>does not affect the load balancing performed for server-to-server connections</li>
</ul></div>
<h5 class="pHeading4"><a name="wp1039876"> </a>
Server Affinity Examples
</h5>
<p class="pBody"><a name="wp1039877"> </a>
The following examples illustrate the effect of server affinity under a variety of circumstances. In each example, the objects deployed are configured for round-robin-affinity. 
</p>
<h5 class="pHeading4"><a name="wp1044278"> </a>
Example 1&#8212;Context from cluster
</h5>
<p class="pBody"><a name="wp1044279"> </a>
In this example, the client obtains context from the cluster. Lookups on the context and object calls stick to a single connection. Requests for new initial context are load balanced on a round-robin basis.
</p>
<div class="pFigureTitle"><a name="wp1045008"> </a>
Figure 5-1   Client Obtains Context From the Cluster
</div>

 
 <p class="pGraphic"><a name="wp1045070"> </a>
</p>
<div class="figure" align="left"><img src="wwimages/context1.gif" alt="Client Obtains Context From the Cluster" id="wp1045058"/></div><p class="pGraphic">

</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1045075"> </a>Client requests a new initial context from the cluster (<code class="cCode">Provider_URL=clusteraddress</code>) and obtains the context from MS1.</li>
<li><a name="wp1039949"> </a>Client does a lookup on the context for Object A. The lookup goes to MS1.</li>
<li><a name="wp1039950"> </a>Client issues a call to Object A. The call goes to MS1, to which the client is already connected. Additional method calls to Object A stick to MS1.</li>
<li><a name="wp1039951"> </a>Client requests a new initial context from the cluster (<code class="cCode">Provider_URL=clusteraddress</code>) and obtains the context from MS2. </li>
<li><a name="wp1039952"> </a>Client does a lookup on the context for Object B. The call goes to MS2, to which the client is already connected. Additional method calls to Object B stick to MS2. </li>
</ol></div>
<h5 class="pHeading4"><a name="wp1041126"> </a>
Example 2&#8212;Server Affinity and Failover
</h5>
<p class="pBody"><a name="wp1045163"> </a>
This example illustrates the effect that server affinity has on object failover. When a Managed Server goes down, the client fails over to another Managed Server to which it has a connection.
</p>
<div class="pFigureTitle"><a name="wp1045164"> </a>
Figure 5-2   Server Affinity and Failover
</div>

 
 <p class="pGraphic"><a name="wp1045168"> </a>
</p>
<div class="figure" align="left"><img src="wwimages/context2.gif" alt="Server Affinity and Failover" id="wp1045166"/></div><p class="pGraphic">

</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1040106"> </a>Client requests new initial context from MS1.</li>
<li><a name="wp1040107"> </a>Client does a lookup on the context for Object A. The lookup goes to MS1.</li>
<li><a name="wp1040108"> </a>Client makes a call to Object A. The call goes to MS1, to which the client is already connected. Additional calls to Object A stick to MS1. </li>
<li><a name="wp1040109"> </a>The client obtains a stub for Object C, which is pinned to MS3. The client opens a connection to MS3. </li>
<li><a name="wp1040110"> </a>MS1 fails. </li>
<li><a name="wp1040111"> </a>Client makes a call to Object A.The client no longer has a connection to MS1. Because the client is connected to MS3, it fails over to a replica of Object A on MS3.</li>
</ol></div>
<h5 class="pHeading4"><a name="wp1041464"> </a>
Example 3&#8212;Server affinity and server-to-server connections
</h5>
<p class="pBody"><a name="wp1041477"> </a>
This example illustrates the fact that server affinity does not affect the connections between server instances.
</p>
<div class="pFigureTitle"><a name="wp1045148"> </a>
Figure 5-3   Server Affinity and Server-to-Server Connections
</div>

 
 <p class="pGraphic"><a name="wp1045176"> </a>
</p>
<div class="figure" align="left"><img src="wwimages/context2.gif" alt="Server Affinity and Server-to-Server Connections" id="wp1045147"/></div><p class="pGraphic">

</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1040175"> </a>A JSP on MS4 obtains a stub for Object B. </li>
<li><a name="wp1040176"> </a>The JSP selects a replica on MS1. For each method call, the JSP cycles through the Managed Servers upon which Object B is available, on a round-robin basis. </li>
</ol></div>
<h3 class="pHeading2"><a name="wp1036227"> </a>
Parameter-Based Routing for Clustered Objects
</h3>
<p class="pBody"><a name="wp1036217"> </a>
Parameter-based routing allows you to control load balancing behavior at a lower level. Any clustered object can be assigned a <code class="cCode">CallRouter</code>. This is a class that is called before each invocation with the parameters of the call. The <code class="cCode">CallRouter</code> is free to examine the parameters and return the name server to which the call should be routed. For information about creating custom <code class="cCode">CallRouter</code> classes, see <span class="cHyperlink">
<a href="../rmi/rmi_api.html#CallRouting">Parameter-Based Routing for Clustered Objects</a></span> in <em class="cEmphasis">Programming WebLogic RMI</em>.
</p>
<h3 class="pHeading2"><a name="wp1026599"> </a>
Optimization for Col<a name="Collocated_objs"></a>located Objects
</h3>
<p class="pBody"><a name="wp1024792"> </a>
WebLogic Server does not always load balance an object&#8217;s method calls. In most cases, it is more efficient to use a replica that is collocated with the stub itself, rather than using a replica that resides on a remote server. The following figure illustrates this.
</p>
<div class="pFigureTitle"><a name="wp1042860"> </a>
Figure 5-4   Collocation Optimization Overrides Load Balancer Logic for Method Call
</div>

 
 <p class="pGraphic"><a name="wp1042901"> </a>
</p>
<div class="figure" align="left"><img src="wwimages/cluster-05-1-4.gif" height="232" width="456" alt="Collocation Optimization Overrides Load Balancer Logic for Method Call" id="wp1042862"/></div><p class="pGraphic">

</p>
<p class="pBody"><a name="wp1042902"> </a>
In this example, a client connects to a servlet hosted by the first WebLogic Server instance in the cluster. In response to client activity, the servlet obtains a replica-aware stub for Object A. Because a replica of Object A is also available on the same server instance, the object is said to be collocated with the client&#8217;s stub. 
</p>
<p class="pBody"><a name="wp1024883"> </a>
WebLogic Server always uses the local, collocated copy of Object A, rather than distributing the client&#8217;s calls to other replicas of Object A in the cluster. It is more efficient to use the local copy, because doing so avoids the network overhead of establishing peer connections to other servers in the cluster.
</p>
<p class="pBody"><a name="wp1024887"> </a>
This optimization is often overlooked when planning WebLogic Server clusters. The collocation optimization is also frequently confusing for administrators or developers who expect or require load balancing on each method call. If your Web application is deployed to a single cluster, the collocation optimization overrides any load balancing logic inherent in the replica-aware stub. 
</p>
<p class="pBody"><a name="wp1024890"> </a>
If you require load balancing on each method call to a clustered object, see <a href="planning.html#wp1115757">Recommended Multi-Tier Architecture</a> for information about how to plan your WebLogic Server cluster accordingly.
</p>
<h4 class="pHeading3"><a name="wp1024895"> </a>
Transactional Collocation
</h4>
<p class="pBody"><a name="wp1024899"> </a>
As an extension to the basic collocation strategy, WebLogic Server attempts to use collocated clustered objects that are enlisted as part of the same transaction. When a client creates a <code class="cCode">UserTransaction</code> object, WebLogic Server attempts to use object replicas that are collocated with the transaction. This optimization is depicted in the figure below.
</p>
<div class="pFigureTitle"><a name="wp1042933"> </a>
Figure 5-5   Collocation Optimization Extends to Other Objects in Transaction
</div>

 
 <p class="pGraphic"><a name="wp1042991"> </a>
</p>
<div class="figure" align="left"><img src="wwimages/cluster-05-1-5.gif" height="335" width="456" alt="Collocation Optimization Extends to Other Objects in Transaction" id="wp1042935"/></div><p class="pGraphic">

</p>
<p class="pBody"><a name="wp1026845"> </a>
In this example, a client attaches to he first WebLogic Server instance in the cluster and obtains a <code class="cCode">UserTransaction</code> object. After beginning a new transaction, the client looks up Objects A and B to do the work of the transaction. In this situation WebLogic Server always attempts to use replicas of A and B that reside on the same server as the <code class="cCode">UserTransaction</code> object, regardless of the load balancing strategies in the stubs for A and B.
</p>
<p class="pBody"><a name="wp1025000"> </a>
This transactional collocation strategy is even more important than the basic optimization described in <a href="load_balancing.html#wp1026599"><span class="cHyperlink">
Optimization for Collocated Objects</span></a>. If remote replicas of A and B were used, added network overhead would be incurred <em class="cEmphasis">for the duration of the transaction</em>, because the peer connections for A and B would be locked until the transaction committed. Furthermore, WebLogic Server would need to employ a multi-tiered JDBC connection to commit the transaction, incurring additional network overhead.
</p>
<p class="pBody"><a name="wp1043744"> </a>
By using collocating clustered objects during a transaction, WebLogic Server reduces the network load for accessing the individual objects. The server also can make use of a single-tiered JDBC connection, rather than a multi-tiered connection, to do the work of the transaction.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1043771"> </a>
Load Balancing<a name="lb_jms"></a> for JMS
</h2><p class="pBody"><a name="wp1043747"> </a>
WebLogic Server JMS supports server affinity for distributed JMS destinations and client connections.
</p>
<p class="pBody"><a name="wp1043031"> </a>
By default, a WebLogic Server cluster uses the round-robin method to load balance objects. To use a load balancing algorithm that provides server affinity for JMS objects, you must configure the desired method for the cluster as a whole. You can configure the load balancing algorithm by using the Administration Console to set <code class="cCode">weblogic.cluster.defaultLoadAlgorithm</code>. For instructions, see <a href="setup.html#wp684313">Configure Load Balancing Method for EJBs and RMIs</a>.
</p>
<a name="wp1045741"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>To provide persistent store for failover of JMS and JTA pinned services, you may consider using high-availability clustering software such as VERITAS&#8482; Cluster Server, which provides an integrated, out-of-the-box solution for BEA WebLogic Server-based applications. Some other recommended high-availability software solutions include SunCluster, IBM HACMP, or the equivalent.</td>
</tr>
</table>

<h3 class="pHeading2"><a name="wp1038369"> </a>
Server Affinity for Distributed JMS Destinations 
</h3>
<p class="pBody"><a name="wp1038370"> </a>
Server affinity is supported for JMS applications that use the distributed destination feature; this feature is not supported for standalone destinations. If you configure server affinity for JMS connection factories, a server instance that is load balancing consumers or producers across multiple members of a distributed destination will first attempt to load balance across any destination members that are also running on the same server instance. 
</p>
<p class="pBody"><a name="wp1044922"> </a>
For detailed information on how the JMS connection factory&#8217;s Server Affinity Enabled option affects the load balancing preferences for distributed destination members, see <span class="cHyperlink">
<a href="../jms/dds.html">&#8220;How Distributed Destination Load Balancing Is Affected When Using the Server Affinity Enabled Attribute&#8221;</a></span> in <em class="cEmphasis">Programming WebLogic JMS</em>.
</p>
<h3 class="pHeading2"><a name="wp1044978"> </a>
Initial <a name="context_affinity"></a>Context Affinity and Server Affinity for Client Connections 
</h3>
<p class="pBody"><a name="wp1043666"> </a>
A system administrator can establish load balancing of JMS destinations across multiple servers in a cluster by configuring multiple JMS servers and using targets to assign them to the defined WebLogic Servers. Each JMS server is deployed on exactly one WebLogic Server and handles requests for a set of destinations. During the configuration phase, the system administrator enables load balancing by specifying targets for JMS servers. For instructions on setting up targets, see <a href="setup.html#wp726721">Configure Migratable Targets for Pinned Services</a>. For instructions on deploying a JMS server to a migratable target, see <a href="setup.html#wp735713">Deploying, Activating, and Migrating Migratable Services</a>.
</p>
<p class="pBody"><a name="wp1043673"> </a>
A system administrator can establish cluster-wide, transparent access to destinations from any server in the cluster by configuring multiple connection factories and using targets to assign them to WebLogic Servers. Each connection factory can be deployed on multiple WebLogic Servers. Connection factories are described in more detail in <span class="cHyperlink">
<a href="../jms/fund.html#1023885">&#8220;Connection Factory&#8221;</a></span> in <em class="cEmphasis">Programming WebLogic JMS</em>.
</p>
<p class="pBody"><a name="wp1043675"> </a>
The application uses the Java Naming and Directory Interface (JNDI) to look up a connection factory and create a connection to establish communication with a JMS server. Each JMS server handles requests for a set of destinations. Requests for destinations not handled by a JMS server are forwarded to the appropriate server.
</p>
<p class="pBody"><a name="wp1038373"> </a>
WebLogic Server provides server affinity for client connections. If an application has a connection to a given server instance, JMS will attempt to establish new JMS connections to the same server instance. 
</p>
<p class="pBody"><a name="wp1038374"> </a>
When creating a connection, JMS will try first to achieve initial context affinity. It will attempt to connect to the same server or servers to which a client connected for its initial context, assuming that the server instance is configured for that connection factory. For example, if the connection factory is configured for servers A and B, but the client has an InitialContext on server C, then the connection factory will not establish the new connection with A, but will choose between servers B and C.
</p>
<p class="pBody"><a name="wp1038376"> </a>
If a connection factory cannot achieve initial context affinity, it will try to provide affinity to a server to which the client is already connected. For instance, assume the client has an InitialContext on server A and some other type of connection to server B. If the client then uses a connection factory configured for servers B and C it will not achieve initial context affinity. The connection factory will instead attempt to achieve server affinity by trying to create a connection to server B, to which it already has a connection, rather than server C.
</p>
<p class="pBody"><a name="wp1038378"> </a>
If a connection factory cannot provide either initial context affinity or server affinity, then the connection factory is free to make a connection wherever possible. For instance, assume a client has an initial context on server A, no other connections and a connection factory configured for servers B and C. The connection factory is unable to provide any affinity and is free to attempt new connections to either server B or C.
</p>
<a name="wp1038365"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>In the last case, if the client attempts to make a second connection using the same connection factory, it will go to the same server as it did on the first attempt. That is, if it chose server B for the first connection, when the second connection is made, the client will have a connection to server B and the server affinity rule will be enforced.</td>
</tr>
</table>

<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1031590"> </a>
Load Balancing for JDBC Connections
</h2><p class="pBody"><a name="wp1031591"> </a>
Load balancing of JDBC connection requires the use of a multi data source configured for load balancing. Load balancing support is an option you can choose when configuring a multi data source. 
</p>
<p class="pBody"><a name="wp1032211"> </a>
A load balancing multi data source provides the high available behavior described in <a href="failover.html#wp1030488">Failover and JDBC Connections</a>, and in addition, balances the load among the data sources in the multi data source. A multi data source has an ordered list of data sources it contains. If you do not configure the multi data source for load balancing, it always attempts to obtain a connection from the first data source in the list. In a load-balancing multi data source, the data sources it contains are accessed using a round-robin scheme. In each successive client request for a multi data source connection, the list is rotated so the first pool tapped cycles around the list.
</p>
<p class="pBody"><a name="wp1031744"> </a>
For instructions on clustering JDBC objects, see <a href="setup.html#wp753730">Configure Clustered JDBC</a>.
</p>
 
<br/>
    <table id="SummaryNotReq2" width="100%" border="0" cellpadding="0" cellspacing="0">
      <tr> 
        <td>
&nbsp;
<a href="load_balancing.html"><img id="LongDescNotReq7" src="../../global_resources/images/backtop.gif" width="90" height="25" alt="Back to Top" title="Back to Top" border="0" /></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="config.html"><img id="LongDescNotReq8" src="../../global_resources/images/prevtop.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="failover.html"><img id="LongDescNotReq9" src="../../global_resources/images/nexttop.gif" border="0" alt="Next" /></a>
<script language="Javascript1.1" type="text/javascript">
Copyright();
</script>
<noscript><a href="http://edocs.bea.com/copyright.html">&copy; BEA Systems</a></noscript>
        </td>
      </tr>
    </table>

<!-- WebAnalytics BEGIN -->

<!--#include virtual="../../global_resources/edocs_wt.html"-->
      
<!-- WebAnalytics END -->

  </body>
</html>
